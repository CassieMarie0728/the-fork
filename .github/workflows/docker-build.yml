name: Build Docker Images

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Backend Image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        file: ./backend/Dockerfile
        tags: fork-backend:${{ github.sha }}
        outputs: type=docker,dest=/tmp/backend-image.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build Frontend Image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        tags: fork-frontend:${{ github.sha }}
        outputs: type=docker,dest=/tmp/frontend-image.tar
        build-args: |
          REACT_APP_BACKEND_URL=http://localhost:8000
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Upload backend image
      uses: actions/upload-artifact@v4
      with:
        name: backend-image
        path: /tmp/backend-image.tar
        retention-days: 1
    
    - name: Upload frontend image
      uses: actions/upload-artifact@v4
      with:
        name: frontend-image
        path: /tmp/frontend-image.tar
        retention-days: 1
    
    - name: Test Docker Compose
      run: |
        # Create mock .env files
        echo "EMERGENT_LLM_KEY=test-key" > .env.docker
        
        # Try to validate docker-compose (requires docker-compose CLI)
        docker-compose config > /dev/null 2>&1 || echo "Validation warning (docker-compose may not be available in CI)"
